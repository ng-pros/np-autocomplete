"use strict";!function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b(require("angular")):"function"==typeof define&&define.amd?define(["angular"],b):b(a.angular)}(window,function(angular){angular.module("ng-pros.directive.autocomplete",[]).directive("npAutocomplete",["$timeout","$http","$compile","$templateCache","$sce",function($timeout,$http,$compile,$templateCache,$sce){return $templateCache.put("np-autocomplete/template.tpl.html",'<div id="np-autocomplete-transclude"></div><div id="np-do-not-touch" style="display: none;"> <button   type="button"   ng-click="clear()"   ng-class="options.messageClass"   ng-bind="options.noResultsMessage"   ng-if="!searchResults.length && !loading && !hasError"> </button> <button   type="button"   ng-if="hasError && !loading"   ng-click="clear()"   ng-class="options.messageClass"   ng-bind="options.errorStateMessage"> </button> <a   ng-if="loading"   ng-class="options.messageClass"   ng-bind="options.loadStateMessage"> </a></div>'),$templateCache.put("np-autocomplete/item-template.tpl.html",'<button type="button"  ng-click="select(item)"  ng-class="getItemClasses($index)"  ng-repeat="item in searchResults"  ng-bind-html="highlight($eval(\'item.\' + options.nameAttr))"  ng-mouseenter="onItemMouseenter($index)"></button>'),{require:"?ngModel",restrict:"A",transclude:!0,scope:{npAuto:"=",ngModel:"=",npInputModel:"=",npSelectedItem:"=",npAutocomplete:"="},link:function(scope,element,attrs,ngModelCtrl,transclude){var id=attrs.id,input=null,template=null,timeoutId=null,listElement=null,itemTemplate=null,hasSelection=!1,isBlurHandlerActive=!0,internalModelChange=!1,internalInputChange=!1,isFocusHandlerActive=!0,options={limit:5,delay:500,params:{},nameAttr:"name",minlength:1,valueAttr:"id",listClass:"list-group",itemClass:"list-group-item",queryMode:!0,limitParam:"limit",templateUrl:"np-autocomplete/template.tpl.html",searchParam:"search",messageClass:"list-group-item",itemFocusClass:"active",highlightClass:"bg-info text-info",openStateClass:"np-autocomplete-open",loadStateClass:"np-autocomplete-load",errorStateClass:"has-error",closeStateClass:"np-autocomplete-close",itemTemplateUrl:"np-autocomplete/item-template.tpl.html",noResultsMessage:"No results found.",loadStateMessage:"Loading...",errorStateMessage:"Something went wrong.",hasSelectionClass:"has-success",highlightExactSearch:!0},open=function(){resize(),listElement.css("display",""),element.removeClass(scope.options.closeStateClass),element.addClass(scope.options.openStateClass)},close=function(){listElement.css("display","none"),element.removeClass(scope.options.openStateClass),element.addClass(scope.options.closeStateClass)},updateSelectionMode=function(a,b){element.removeClass(scope.options.errorStateClass),scope.hasError=!1,a?(element.addClass(scope.options.hasSelectionClass),b&&!hasSelection&&scope.options.onSelect&&scope.options.onSelect(b)):(element.removeClass(scope.options.hasSelectionClass),hasSelection&&scope.options.onDeselect&&scope.options.onDeselect()),hasSelection=a},flush=function(a){return $timeout.cancel(timeoutId),scope.focusedItemIndex=-1,attrs.npSelectedItem&&(scope.npSelectedItem=null),attrs.ngModel&&(internalModelChange=!0,ngModelCtrl.$setViewValue()),updateSelectionMode(!1),a=void 0!==a?a:input.val(),attrs.npInputModel&&(internalInputChange=!0,scope.npInputModel=a),$timeout(function(){scope.searchResults=[]}),a},change=function(delay){close();var val=flush();val&&val.length>=scope.options.minlength&&(timeoutId=$timeout(function(){scope.loading=!0,element.addClass(scope.options.loadStateClass),open();var url=scope.options.url;scope.options.queryMode?scope.options.params[scope.options.searchParam]=val:url=url.replace(new RegExp(":searchParam","g"),val),$http.get(url,{params:scope.options.params})["finally"](function(){scope.loading=!1,element.removeClass(scope.options.loadStateClass)}).then(function(response){var data=response.data;if(scope.options.dataHolder&&(data=eval("data."+scope.options.dataHolder)),scope.options.each)for(var resultsLength=data.length,i=0;resultsLength>i;i++)scope.options.each(data[i]);scope.searchResults=data,scope.focusedItemIndex=0})["catch"](function(a){scope.hasError=!0,element.addClass(scope.options.errorStateClass),scope.options.onError&&scope.options.onError(a)})},delay))},blurHandler=function(a){isBlurHandlerActive&&!angular.element.contains(listElement[0],a.target)&&input[0]!==a.target&&(close(),scope.options.onBlur&&scope.options.onBlur()),isBlurHandlerActive=!0},focusHandler=function(){if(isFocusHandlerActive){var a=input.val();a&&a.length>=scope.options.minlength&&!hasSelection&&open()}isFocusHandlerActive=!0},resize=function(){var a=input.position();listElement.css({top:a.top+input.outerHeight(),width:input.outerWidth()}),"ltr"===listElement.css("direction")?listElement.css("left",a.left):listElement.css("right",a.right)},focusNextListItem=function(){scope.focusedItemIndex=scope.focusedItemIndex<0?0:++scope.focusedItemIndex%scope.searchResults.length};scope.options=angular.extend({},options,scope.npAutocomplete),scope.searchResults=[],scope.focusedItemIndex=-1,scope.options.delay=scope.options.delay>100?scope.options.delay:100,scope.options.params[scope.options.limitParam]=scope.options.limit,id||(id="np-autocomplete-"+Date.now(),element.attr("id",id)),template=angular.element(scope.options.template||$templateCache.get(scope.options.templateUrl)),itemTemplate=scope.options.itemTemplate||$templateCache.get(scope.options.itemTemplateUrl),listElement=template.closest("#np-do-not-touch"),listElement.removeAttr("id"),listElement.addClass(scope.options.listClass),listElement.append(itemTemplate),element.html($compile(template)(scope)),element.find("#np-autocomplete-transclude").replaceWith(transclude()),element.addClass("np-autocomplete-wrapper"),element.addClass(scope.options.closeStateClass),input=element.find("input"),resize(),input.on("input",function(){change(scope.options.delay)}),input.keydown(function(a){var b=!1;if(!scope.loading&&scope.searchResults.length&&!hasSelection)switch(b=!0,a.keyCode){case 38:scope.focusedItemIndex=scope.focusedItemIndex<1?scope.searchResults.length-1:scope.focusedItemIndex-1;break;case 40:focusNextListItem();break;case 13:scope.select(scope.searchResults[scope.focusedItemIndex]);break;case 9:focusNextListItem();break;default:b=!1}scope.$$phase||scope.$apply(),b&&a.preventDefault()}),input.focus(focusHandler),angular.element(window).on("resize",resize),angular.element(document).on("click keyup",blurHandler),scope.select=function(item){$timeout.cancel(timeoutId),close(),attrs.ngModel&&(internalModelChange=!0,ngModelCtrl.$setViewValue(eval("item."+scope.options.valueAttr))),updateSelectionMode(!0,item);var val=scope.options.clearOnSelect?"":eval("item."+scope.options.nameAttr);attrs.npInputModel?scope.npInputModel=val:input.val(val),attrs.npSelectedItem&&(scope.npSelectedItem=item),isFocusHandlerActive=isBlurHandlerActive=!1,input.focus()},scope.clear=function(){close(),input.val(flush("")),scope.searchResults=[],isFocusHandlerActive=!1,input.focus()},scope.highlight=function(a){var b=input.val().trim().replace(/([{}()[\]\\.?*+^$|=!:~-])/g,"\\$1"),c=new RegExp(scope.options.highlightExactSearch?b:b.replace(/\s+/,"|"),"ig"),d=a?a:"";return $sce.trustAsHtml(d.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(c,'<mark class="'+scope.options.highlightClass+'">$&</mark>'))},scope.onItemMouseenter=function(a){scope.focusedItemIndex=a},scope.getItemClasses=function(a){var b={};return b[scope.options.itemClass]=scope.options.itemClass,b[scope.options.itemFocusClass]=scope.options.itemFocusClass&&a===scope.focusedItemIndex,b},attrs.ngModel&&scope.$watch("ngModel",function(a){internalModelChange||($timeout.cancel(timeoutId),updateSelectionMode(void 0!==a&&null!==a&&""!==a),close()),internalModelChange=!1}),attrs.npInputModel&&scope.$watch("npInputModel",function(a){internalInputChange||input.val(a),internalInputChange=!1}),attrs.npAuto&&scope.$watch("npAuto",function(a){a&&($timeout.cancel(timeoutId),scope.npAuto=null,a!==input.val()&&(input.val(a),change(0),isFocusHandlerActive=!1),isBlurHandlerActive=!1,input.focus())}),scope.$on("$destroy",function(){angular.element(window).off("resize",resize),angular.element(document).off("click keyup",blurHandler)})}}}])});